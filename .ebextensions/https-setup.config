packages:
  yum:
    certbot: []
    python3-certbot-nginx: []

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_setup_ssl.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      DOMAIN="pfdb.garrettw.net"

      # Get email from environment variable, fallback to a generic one
      EMAIL=${LETSENCRYPT_EMAIL:-"admin@$(echo $DOMAIN | cut -d'.' -f2-)"}

      echo "Using email: $EMAIL for domain: $DOMAIN"

      # Only get certificate if it doesn't exist
      if [ ! -f /etc/letsencrypt/live/$DOMAIN/fullchain.pem ]; then
        echo "Getting SSL certificate for $DOMAIN"

        # Stop nginx temporarily for standalone mode
        service nginx stop

        # Get certificate
        certbot certonly --standalone --non-interactive --agree-tos \
          --email $EMAIL -d $DOMAIN

        if [ $? -eq 0 ]; then
          echo "Certificate obtained successfully"
        else
          echo "Failed to obtain certificate"
          service nginx start
          exit 1
        fi

        # Start nginx
        service nginx start
      else
        echo "Certificate already exists for $DOMAIN"
      fi

  "/etc/cron.d/certbot-renewal":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Renew certificates twice daily and reload nginx if renewed
      0 0,12 * * * root /usr/bin/certbot renew --quiet --post-hook "service nginx reload" >> /var/log/certbot-renewal.log 2>&1

commands:
  01_setup_ssl:
    command: "/opt/elasticbeanstalk/hooks/appdeploy/post/99_setup_ssl.sh"
    ignoreErrors: false
