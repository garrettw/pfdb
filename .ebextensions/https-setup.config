packages:
  yum:
    certbot: []
    python3-certbot-nginx: []

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_setup_ssl.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      DOMAIN="pfdb.garrettw.net"

      # Get email from environment variable, fallback to a generic one
      EMAIL=${LETSENCRYPT_EMAIL:-"admin@$(echo $DOMAIN | cut -d'.' -f2-)"}

      echo "Using email: $EMAIL for domain: $DOMAIN"

      # Only get certificate if it doesn't exist
      if [ ! -f /etc/letsencrypt/live/$DOMAIN/fullchain.pem ]; then
        echo "Getting SSL certificate for $DOMAIN"

        # Stop nginx temporarily for standalone mode
        service nginx stop

        # Get certificate
        certbot certonly --standalone --non-interactive --agree-tos \
          --email $EMAIL -d $DOMAIN

        if [ $? -eq 0 ]; then
          echo "Certificate obtained successfully"
        else
          echo "Failed to obtain certificate"
          service nginx start
          exit 1
        fi

        # Start nginx
        service nginx start
      else
        echo "Certificate already exists for $DOMAIN"
      fi

      # Create SSL server block that includes the healthd variables
      cat > /etc/nginx/conf.d/custom-ssl.conf << 'EOF'

      include conf.d/healthd_format.conf;

      server {
          listen 443 ssl;
          http2 on;
          server_name pfdb.garrettw.net;

          ssl_certificate /etc/letsencrypt/live/pfdb.garrettw.net/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/pfdb.garrettw.net/privkey.pem;

          # Modern SSL configuration
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
          ssl_prefer_server_ciphers off;
          ssl_session_cache shared:SSL:10m;

          # Include healthd config first to set up the time variables
          include conf.d/elasticbeanstalk/healthd.conf;

          client_header_timeout 60;
          client_body_timeout   60;
          keepalive_timeout     60;

          # Now include the rest of the EB configs
          include conf.d/elasticbeanstalk/*.conf;
      }
      EOF

      # Modify the existing default server block to add server_name
      cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup

      # Add a separate server block for HTTP custom domain redirect
      cat > /etc/nginx/conf.d/custom-redirect.conf << 'EOF'
      server {
          listen 80;
          server_name pfdb.garrettw.net;
          return 301 https://$server_name$request_uri;
      }
      EOF

      # Test nginx configuration
      nginx -t
      if [ $? -eq 0 ]; then
        echo "Nginx configuration is valid, reloading..."
        service nginx reload
      else
        echo "Nginx configuration error! Restoring backup..."
        cp /etc/nginx/nginx.conf.backup /etc/nginx/nginx.conf
        rm -f /etc/nginx/conf.d/custom-ssl.conf /etc/nginx/conf.d/custom-redirect.conf
        nginx -t  # Show the error
        exit 1
      fi

  "/etc/cron.d/certbot-renewal":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Renew certificates twice daily and reload nginx if renewed
      0 0,12 * * * root /usr/bin/certbot renew --quiet --post-hook "service nginx reload" >> /var/log/certbot-renewal.log 2>&1

commands:
  01_setup_ssl:
    command: "/opt/elasticbeanstalk/hooks/appdeploy/post/99_setup_ssl.sh"
    ignoreErrors: false
