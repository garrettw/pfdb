container_commands:
  01_migrate:
    # Use EB get-config to read environment properties at runtime and capture output
    command: >-
      /bin/bash -lc "export DB_CONNECTION=$(/opt/elasticbeanstalk/bin/get-config environment -k DB_CONNECTION 2>/dev/null || echo sqlite); \
      export DB_HOST=$(/opt/elasticbeanstalk/bin/get-config environment -k DB_HOST 2>/dev/null || true); \
      export DB_DATABASE=$(/opt/elasticbeanstalk/bin/get-config environment -k DB_DATABASE 2>/dev/null || true); \
      export DB_USERNAME=$(/opt/elasticbeanstalk/bin/get-config environment -k DB_USERNAME 2>/dev/null || true); \
      export DB_PASSWORD=$(/opt/elasticbeanstalk/bin/get-config environment -k DB_PASSWORD 2>/dev/null || true); \
      echo "[eb-migrate] DB_CONNECTION=$DB_CONNECTION DB_DATABASE=$DB_DATABASE" > /var/log/eb-migrate.log; \
      if [ "$DB_CONNECTION" = "sqlite" ] && [ ! -f database/database.sqlite ]; then \
        echo "[eb-migrate] sqlite DB file missing; skipping migrate" >> /var/log/eb-migrate.log; \
      else \
        php artisan migrate --force >> /var/log/eb-migrate.log 2>&1 || (echo "[eb-migrate] migrate command failed" >> /var/log/eb-migrate.log; exit 1); \
      fi"
    leader_only: true
  02_cache:
    command: "php artisan config:cache"
